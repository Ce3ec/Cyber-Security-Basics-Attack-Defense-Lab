name: Branch Protection

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main

jobs:
  protect-main:
    # Blocca SOLO push diretti, NON le PR
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Block direct push to main
        run: |
          echo "Il push diretto al main non è permesso. Usa una Pull Request da dev."
          exit 1

  check-dev-commits:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Blocca force push su dev
      - name: Block force push on dev
        run: |
          if [ "${{ github.event.forced }}" = "true" ]; then
            echo "Il push forzato su dev non è permesso!"
            exit 1
          fi

      # Controllo keyword nei commit pushati
      - name: Check commit messages for keywords
        run: |
          commit=$(git log --no-merges -1 --pretty=format:"%s")
          for commit in $commits; do
            if ! [[ "$commit" =~ AGGIUNTO|MODIFICATO|FIX|RIMOSSO|DEL ]]; then
              echo "Il messaggio '$commit' non contiene keyword valide (AGGIUNTO, MODIFICATO, FIX, RIMOSSO, DEL)"
              exit 1
            fi
          done
