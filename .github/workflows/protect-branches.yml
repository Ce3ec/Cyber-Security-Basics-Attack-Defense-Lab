name: Branch Protection

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main

jobs:
  check-pr-to-main:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Validate pull request to main
        run: |
          echo "Pull Request detected"
          echo "Target branch: ${{ github.event.pull_request.base.ref }}"
          echo "Source branch: ${{ github.event.pull_request.head.ref }}"
          echo "PR is allowed"

  check-dev-commits:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Block force push on dev
        run: |
          if [ "${{ github.event.forced }}" = "true" ]; then
            echo "Il push forzato su dev non Ã¨ permesso!"
            exit 1
          fi

      - name: Check commit messages for keywords
        run: |
          commit=$(git log --no-merges -1 --pretty=format:"%s")
          echo "Checking commit: $commit"

          if ! echo "$commit" | grep -Ei "(ADD|UPDATE|FIX|DEL|TEST)"; then

            echo "Il messaggio '$commit' non contiene keyword valide (ADD, UPDATE, FIX, TEST, DEL)"

            exit 1
          fi
