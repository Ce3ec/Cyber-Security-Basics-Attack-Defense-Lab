name: Branch Protection

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main

jobs:
  check-pr-to-main:
    runs-on: ubuntu-latest
    steps:
      - name: Allow only PRs from dev
        run: |
          echo "Base branch: ${{ github.base_ref }}"
          echo "Head branch: ${{ github.head_ref }}"

          if [ "${{ github.head_ref }}" != "dev" ]; then
            echo "Solo le Pull Request da dev a main sono permesse."
            exit 1
          fi

  check-dev-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Block force push on dev
        run: |
          if [ "${{ github.event.forced }}" = "true" ]; then
            echo "Il push forzato su dev non Ã¨ permesso!"
            exit 1
          fi

      - name: Check commit messages for keywords
        run: |
          commit=$(git log --no-merges -1 --pretty=format:"%s")
          echo "Checking commit: $commit"

          if ! echo "$commit" | grep -Ei "(AGGIUNTO|MODIFICATO|FIX|RIMOSSO|DEL)"; then
            echo "Il messaggio '$commit' non contiene keyword valide (AGGIUNTO, MODIFICATO, FIX, RIMOSSO, DEL)"
            exit 1
          fi
